# This file is a template, and might need editing before it works on your project.
# variables:
#   GIT_SUBMODULE_STRATEGY: recursive

image: node:14

stages:
  - test
  - build-and-deploy

# This folder is cached between builds
# http://docs.gitlab.com/ee/ci/yaml/README.html#cache
cache:
  paths:
    - node_modules/

test:
  stage: test
  variables:
    AWS_S3_PREFIX: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
  before_script:
    # Create ssh-key and pull submodule
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo "$SSH_DEPLOY_KEY"
    - echo -e "$SSH_DEPLOY_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - git submodule update --init --recursive
  script:
    - npm install
    - npm run build --prefix-paths
    - npm run deploy
  only:
    - merge_requests
  tags:
    - runner-191

build-and-deploy:
  stage: build-and-deploy
  before_script:
    # Create ssh-key and pull submodule
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo "$SSH_DEPLOY_KEY"
    - echo -e "$SSH_DEPLOY_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - git submodule update --init --recursive
  script:
    - npm install
    # - ./node_modules/.bin/gatsby build --prefix-paths
    # - cp -rf src/images public/images
    # - ls public/
    # Chưa xử lý phần xóa các file cũ của folder /var/www/html/docs.sliving/. Hiện tại chỉ ghi đè các file cùng tên
    # - scp -i ~/.ssh/id_rsa -P 22006 -r public/* sst-ci@sst-ci.vm.sunshinetech.ai:/var/www/html/docs.sliving/
    - npm run build
    - npm run deploy
  only:
    - master
  tags:
    - runner-191
